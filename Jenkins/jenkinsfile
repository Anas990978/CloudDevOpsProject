@Library('shared-lib') _

pipeline {
  agent any

  environment {
    // App folder (where Dockerfile context is)
    WORK_DIR = 'App'

    // AWS/ECR
    AWS_REGION = 'us-east-1'
    AWS_CREDS  = 'aws-creds'  // AWS Credentials 
    ECR_URI    = '637423620989.dkr.ecr.us-east-1.amazonaws.com/ivolve-app'
    IMAGE_TAG  = "${BUILD_NUMBER}"

    // GitOps
    DEPLOYMENT_FILE = 'k8s/deployment.yaml'
    GIT_TOKEN_ID    = 'GitHub'     
    TARGET_BRANCH   = 'main'       
  }

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  stages {

    stage('Checkout SCM') {
      steps {
        checkout scm
      }
    }

    stage('Build Image') {
      steps {
        dir("${WORK_DIR}") {
          buildImage(WORK_DIR, ECR_URI, IMAGE_TAG)
        }
      }
    }

    stage('Security Scan') {
      steps {
        scanImage(ECR_URI, IMAGE_TAG)
      }
    }

    stage('Push Image') {
      steps {
        pushImage(ECR_URI, IMAGE_TAG, AWS_REGION, AWS_CREDS)
      }
    }

    stage('Cleanup Local Image') {
      steps {
        removeImageLocally(ECR_URI, IMAGE_TAG)
      }
    }

    stage('Update K8s Manifest (GitOps)') {
      steps {
        script {
          
          updateDeploymentManifist(
            ECR_URI.toString(),
            IMAGE_TAG.toString(),
            DEPLOYMENT_FILE.toString(),
            GIT_TOKEN_ID.toString()
          )
        }
      }
    }
  }

  post {
    success { echo 'Pipeline completed successfully' }
    failure { echo 'Pipeline failed' }
    always  { sh "docker logout ${ECR_URI.split('/')[0]} || true" }
  }
}
