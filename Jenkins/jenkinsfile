@Library('shared-lib') _

pipeline {
  agent any
  environment {
    WORK_DIR = 'App'
    // ECR image
    AWS_REGION = 'us-east-1'
    AWS_CREDENTIALS_ID = 'aws-creds'
    ACCOUNT_ID = '123456789012'
    ECR_REPO = 'flask-app'
    ECR_URI = "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}"
    IMAGE_TAG = "${BUILD_NUMBER}"
    FULL_IMAGE = "${ECR_URI}:${IMAGE_TAG}"

    // GitOps manifests
    DEPLOYMENT_FILE = 'k8s/deployment.yaml'
    CONTAINER_NAME = 'flask-app'
    GIT_TOKEN_ID = 'github-token'
  }

  stages {

    stage('Build Image') {
      steps {
        dir("${WORK_DIR}") {
          script { buildLib.call(env.FULL_IMAGE) }
        }
      }
    }

    stage('Scan Image') {
      steps {
        script { scanLib.call(env.FULL_IMAGE) }
      }
    }

    stage('Push Image') {
      steps {
        script { pushLib.call(env.FULL_IMAGE, env.AWS_REGION, env.AWS_CREDENTIALS_ID) }
      }
    }

    stage('Delete Image') {
      steps {
        script { deleteLib.call(env.FULL_IMAGE) }
      }
    }

    stage('Update Manifests') {
      steps {
        script { updateLib.call(env.DEPLOYMENT_FILE, env.CONTAINER_NAME, env.FULL_IMAGE) }
      }
    }

    stage('Push Manifests') {
      steps {
        script { pushMan.call(env.GIT_TOKEN_ID, "chore(gitops): update image to ${env.IMAGE_TAG} [skip ci]") }
      }
    }
  }

  post {
    always {
      echo 'Pipeline execution completed'
      sh 'docker logout || true'
    }
  }
}
