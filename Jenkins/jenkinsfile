@Library('shared-lib') _

pipeline {
  agent any

  environment {
    // App location
    WORK_DIR = 'App'

    // AWS/ECR
    AWS_REGION = 'us-east-1'
    AWS_CREDS  = 'aws-creds'          // Jenkins credentials ID (AWS Credentials)

    ECR_URI    = "637423620989.dkr.ecr.us-east-1.amazonaws.com/ivolve-app"

    IMAGE_TAG  = "${BUILD_NUMBER}"

    // GitOps
    DEPLOYMENT_FILE = 'k8s/deployment.yaml'
    CONTAINER_NAME  = 'flask-app'
    GIT_TOKEN_ID    = 'GitHub'  // Jenkins Secret text
  }

  stages {

    stage('Build Image') {
      steps {
        buildImage(WORK_DIR, ECR_URI, IMAGE_TAG)
      }
    }

    stage('Security Scan') {
      steps {
        scanImage(ECR_URI, IMAGE_TAG)
      }
    }

    stage('Push Image') {
      steps {
        // If you use IAM role on Jenkins EC2, call ecrPushImage without creds
        pushImage(ECR_URI, IMAGE_TAG, AWS_REGION, AWS_CREDS)
      }
    }

    stage('Cleanup Local Image') {
      steps {
        removeImageLocally(ECR_URI, IMAGE_TAG)
      }
    }

    stage('Update K8s Manifest (GitOps)') {
      steps {
        updateDeploymentManifist(
          DEPLOYMENT_FILE,
          CONTAINER_NAME,
          "${ECR_URI}:${IMAGE_TAG}",
          GIT_TOKEN_ID,
          "chore(gitops): update image to ${IMAGE_TAG} [skip ci]"
        )
      }
    }
  }

  post {
    success { echo 'Pipeline completed successfully' }
    failure { echo 'Pipeline failed' }
    always  { sh 'docker logout || true' }
  }
}
